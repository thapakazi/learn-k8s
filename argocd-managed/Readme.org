#+TITLE: ArgoCD Multi-Cluster Setup with Kind
#+DATE: Thursday, Jan 16 2026

Multi-cluster ArgoCD setup using Kind clusters. A management cluster runs ArgoCD and manages applications across workload clusters.

** Prerequisites
- kind
- kubectl
- docker
- just (task runner)
- argocd CLI (optional)

** Quick Start

Full setup (creates clusters, networking, ArgoCD, registers workloads, deploys apps):
#+begin_src bash
just setup-all
#+end_src

Full cleanup:
#+begin_src bash
just cleanup
#+end_src

** Configuration

Default workload clusters are defined in =justfile=:
#+begin_src just
workloads := "east west north south mars"
#+end_src

** Available Commands

View all commands:
#+begin_src bash
just --list
#+end_src

*** Workflows
| Command              | Description                                        |
|----------------------+----------------------------------------------------|
| =just setup-all=     | Full setup: clusters, network, argocd, apps        |
| =just cleanup=       | Full cleanup: delete all clusters and network      |
| =just add <name>=    | Add a new workload cluster (create + register)     |
| =just remove <name>= | Remove a workload cluster (unregister + delete)    |

*** Clusters
| Command                    | Description                          |
|----------------------------+--------------------------------------|
| =just cluster <name>=      | Create a workload cluster            |
| =just cluster-mgmt=        | Create management cluster            |
| =just clusters-create=     | Create mgmt + all workload clusters  |
| =just clusters-delete=     | Delete all clusters                  |
| =just cluster-delete <name>= | Delete a specific workload cluster |
| =just contexts=            | Show kubectl contexts                |

*** Network
| Command                     | Description                              |
|-----------------------------+------------------------------------------|
| =just network-setup=        | Setup docker network for all clusters    |
| =just network-connect <name>= | Connect a cluster to the network       |
| =just network-cleanup=      | Remove docker network                    |

*** ArgoCD
| Command               | Description                    |
|-----------------------+--------------------------------|
| =just argocd-install= | Install ArgoCD on mgmt cluster |
| =just argocd-password= | Get admin password            |
| =just argocd-portfwd= | Port-forward ArgoCD UI (6002) |
| =just argocd-login=   | Login to ArgoCD CLI            |

*** Workload Registration
| Command                  | Description                              |
|--------------------------+------------------------------------------|
| =just setup <name>=      | Setup argocd-manager on workload cluster |
| =just register <name>=   | Register cluster with ArgoCD             |
| =just register-all=      | Register all workload clusters           |
| =just argocd-clusters=   | Show registered clusters                 |

*** Apps
| Command                   | Description                    |
|---------------------------+--------------------------------|
| =just apps-deploy=        | Deploy all apps from apps/     |
| =just app-deploy <name>=  | Deploy a specific app          |
| =just apps-delete=        | Remove all deployed apps       |
| =just apps-list=          | Show ApplicationSets           |
| =just apps-status=        | Show all ArgoCD Applications   |

** Adding a New Cluster

To add a new workload cluster (e.g., jupiter):
#+begin_src bash
just add jupiter
#+end_src

This will:
1. Create the Kind cluster (auto-generates config if needed)
2. Connect it to the =argo-kind= docker network
3. Setup =argocd-manager= service account with token
4. Register the cluster with ArgoCD

To remove it:
#+begin_src bash
just remove jupiter
#+end_src

** Access ArgoCD UI

#+begin_src bash
just argocd-portfwd
#+end_src

Then open https://localhost:6002

Get the admin password:
#+begin_src bash
just argocd-password
#+end_src

** Architecture

#+begin_example
┌─────────────────────────────────────────────────────────────┐
│                    argo-kind network                        │
│                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐       │
│  │    mgmt     │   │ workload-   │   │ workload-   │  ...  │
│  │  (ArgoCD)   │──▶│    east     │   │    west     │       │
│  └─────────────┘   └─────────────┘   └─────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
#+end_example
